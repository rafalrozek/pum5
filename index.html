<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Canvas3</title>
  <meta name="author" content="Rafał Rożek">

  <style>
    body {
    margin: 0px;
    padding: 0px;
    }
  </style>


</head>
<body>
    <canvas id="myCanvas" width="800" height="600" />
</body>
<script>
  
    let cars = new Array();
    let borders = new Array();
    let lines = new Array();
    let balls = new Array();
    let bonuses = new Array();
    var pressedKeys = {};

    let lane = 1;
    let carX = 280;
    let inGame = true;
    let points = 0;
    let speed = 1;
    var lastShoot = new Date().getTime();

    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    function randomIntFromInterval(min, max) { // min and max included 
        return Math.floor(Math.random() * (max - min + 1) + min)
}


    cars.push({x: 420, y: 0})


    borders.push({x: 220, y: -200})
    borders.push({x: 220, y: 0})
    borders.push({x: 220, y: 200})
    borders.push({x: 220, y: 400})


    borders.push({x: 550, y: -200})
    borders.push({x: 550, y: 0})
    borders.push({x: 550, y: 200})
    borders.push({x: 550, y: 400})


    lines.push({x: 395, y: 500});
    lines.push({x: 395, y: 150});

    bonuses.push({x: randomIntFromInterval(280, 500), y: 0})


    async function initScene() {

        while(inGame){
            if(pressedKeys[32]){
                currDate = new Date().getTime();
                if(currDate - lastShoot > 200){
                    lastShoot = currDate;
                    balls.push({x:carX+50, y:450})
                }

            }
            if(pressedKeys[37]){
                carX -= 2;
                if(carX < 280){
                    carX = 280;
                } 
            }
            if(pressedKeys[39]){
                carX += 2;
                if(carX > 420){
                    carX = 420;
                }
            }
            if(pressedKeys[38]){
                //up
                speed += 0.005;
            }
            if(pressedKeys[40]){
                //down
                speed -= 0.005;
                if(speed < 1){
                    speed = 1;
                }
            }

            //draw grass
            ctx.beginPath();
            ctx.fillStyle = "green";
            ctx.rect(0, 0, 800, 600);
            ctx.fill();
            ctx.closePath();

            //draw track
            ctx.beginPath();
            ctx.fillStyle = "#333";
            ctx.rect(250, 0, 300, 600);
            ctx.fill();
            ctx.closePath();
            console.log(speed)


            //draw middle lines
            lines.forEach( (l, li, lo) => {
                ctx.beginPath();
                ctx.fillStyle = "white";
                ctx.rect(l.x, l.y, 10, 100);
                ctx.fill();
                ctx.closePath();

                l.y += 3*speed;
                if(l.y > 600){
                    //destroy line push new one
                    lines.splice(li, 1);
                    lines.push({x: 395, y: -100});
                }
            });

            //draw car
            ctx.beginPath();
            ctx.fillStyle = "black";
            ctx.arc(carX+10, 480, 20, 0, 2 * Math.PI, false);
            ctx.fill();
            ctx.closePath();
            
            ctx.beginPath();
            ctx.fillStyle = "black";
            ctx.arc(carX+90, 480, 20, 0, 2 * Math.PI, false);
            ctx.fill();
            ctx.closePath();


            ctx.beginPath();
            ctx.fillStyle = "black";
            ctx.arc(carX+10, 590, 20, 0, 2 * Math.PI, false);
            ctx.fill();
            ctx.closePath();

            ctx.beginPath();
            ctx.fillStyle = "black";
            ctx.arc(carX+90, 590, 20, 0, 2 * Math.PI, false);
            ctx.fill();
            ctx.closePath();

            ctx.beginPath();
            ctx.fillStyle = "red";


            ctx.rect(carX , 450, 100 , 150);
            ctx.fill();
            ctx.closePath();

            //draw borders
            borders.forEach( (b, bi, bo) => {
                ctx.beginPath();
                ctx.fillStyle = "red";
                ctx.rect(b.x, b.y, 30, 50);
                ctx.fill();
                ctx.closePath();
                ctx.beginPath();
                ctx.fillStyle = "white";
                ctx.rect(b.x, b.y+50, 30, 50);
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.fillStyle = "red";
                ctx.rect(b.x, b.y+100, 30, 50);
                ctx.fill();
                ctx.closePath();
                ctx.beginPath();
                ctx.fillStyle = "white";
                ctx.rect(b.x, b.y+150, 30, 50);
                ctx.fill();
                ctx.closePath();


                b.y+=3*speed;
                
    

                if(b.y > 600){
                    borders.splice(bi, 1);
                    borders.push({x: b.x, y: -200})

                }
                
            });

            //draw enemys
            cars.forEach( (c, ci, co) => {
                ctx.beginPath();
                ctx.fillStyle = "blue";
                ctx.rect(c.x, c.y, 100, 150);
                ctx.fill();
                ctx.closePath();

                c.y += 1 * speed;

                if(c.x > carX-100 && c.x < carX+100 && c.y >= 300){
                    inGame = false;
                    ctx.font = '60px serif';
                    ctx.fillStyle = "white";
                    ctx.fillText('Game over', 270, 200);
                    ctx.fillStyle = "black";
                    ctx.fillText('Game over', 270, 197);
                }

                if(c.y > 600){
                    cars.splice(ci, 1);
                    if(Math.random() > 0.5){
                        cars.push({x: 420, y: -150});
                    }
                    else{
                        cars.push({x: 280, y: -150});
                    }
                    
                }
            });

            balls.forEach( b => {
                ctx.beginPath();
                ctx.fillStyle = "yellow";
                ctx.arc(b.x, b.y, 6, 0, 2 * Math.PI, false);
                ctx.fill();
                ctx.closePath();

                b.y--;
            })

            bonuses.forEach( (b, bi, bo)=> {
                ctx.beginPath();
                ctx.fillStyle = "orange";
                ctx.arc(b.x, b.y, 10, 0, 2 * Math.PI, false);
                ctx.fill();
                ctx.closePath();

                b.y += 1.5 * speed;

                if(b.y > 600){
                    bonuses.splice(bi, 1);
                    bonuses.push({x: randomIntFromInterval(280,500), y: 0})
                }

                if(b.x > carX-100 && b.x < carX + 100 && b.y >= 450){
                    points++;
                    bonuses.splice(bi, 1);
                    bonuses.push({x: randomIntFromInterval(280,500), y: 0})
                }
            })


            balls.forEach( (b, bi, bo) => {
                cars.forEach( (c, ci, co)=> { 
                    if(b.x > c.x && b.x < (c.x + 100) && b.y < c.y+150){
                        balls.splice(bi, 1);
                        cars.splice(ci, 1);

                        if(Math.random() > 0.5){
                        cars.push({x: 420, y: -150});
                    }
                    else{
                        cars.push({x: 280, y: -150});
                    }
                    }
                })

                if(b.y < 0){
                    balls.splice(bi, 1);
                }
            })

            //draw score
            ctx.font = '26px serif';
            ctx.fillStyle = "white";
            ctx.fillText(points + ' points', 700, 50);
            await new Promise(r => setTimeout(r, 1));
        }




        }
    

    window.onload = initScene;
    window.addEventListener('keydown',this.handleKey,false);

    window.onkeyup = function(e) { pressedKeys[e.keyCode] = false; }
window.onkeydown = function(e) { pressedKeys[e.keyCode] = true; }

</script>
</html>